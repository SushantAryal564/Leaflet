<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet Tutorial</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
      integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
      crossorigin=""
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
      integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
      crossorigin=""
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
      integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      #mapdiv {
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="mapdiv" class="col-md-9"></div>
    <div id="side-bar">
      <button id="btnLocate" class="btn btn-primary btn-block">Locate</button>
      <button id="btnZocalo" class="btn btn-primary btn-block">ZoomToZocalo</button>
      <h4>Zoom Level: <span id="zoom-level"></span></h4>
      <h4>Map Center: <span id="map-center"></span></h4>
      <h4>Mouse-Location: <span id="mouse-location"/></span></h4>

    </div>
    <script>
      var mymap;
      var lyresri;
      var mrkCurrentLocation;
      var popZocalo;
      var popExample;

      mymap = L.map("mapdiv", {
        center: [19.4, -99.2],
        zoom: 5,
        zoomControl: true,
        zoomDelta: 1,
        dragging: true,
        minZoom: 5,
        maxZoom: 17,
        attributionControl: false,
        trackResize: true,
        boxZoom: true,
        doubleClickZoom: true,
      });
      lyresri = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          attribution:
            "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
        }
      );
      mymap.addLayer(lyresri);
      // setInterval(function () {
      //   mymap.locate();
      // }, 5000);
      popZocalo = L.popup({maxWidth:200,keepInView:true});

      popZocalo.setLatLng([19.43262,-99.13325]);
      popZocalo.setContent("<h2>Zocalo</h2><img src='./img/zocalo.jpg' style='width:200px'/>");
      
      popExample = L.popup();
      popExample.setLatLng([19.4132,-99.1859]);
      popExample.setContent($("#side-bar")[0])
      popExample.openOn(mymap);

      mymap.on("click", function (e) {
        console.log(e);
        if (e.originalEvent.shiftKey) {
          alert(mymap.getZoom());
        } else {
          alert(e.latlng.toString());
        }
      });
      mymap.on("contextmenu", function (e) {
        let dtCurrentTime = new Date();
        L.marker(e.latlng)
          .addTo(mymap)
          .bindPopup(e.latlng.toString() + "<br>" + dtCurrentTime.toString());
      });
      mymap.on("keypress", function (e) {
        console.log(e);
        if (e.originalEvent.key == "l") {
          mymap.locate();
        }
      });
      mymap.on("locationfound", function (e) {
        console.log(e);
        if (mrkCurrentLocation) {
          mrkCurrentLocation.remove();
        }
        mrkCurrentLocation = L.circle(e.latlng, {
          radius: e.accuracy / 2,
        }).addTo(mymap);
        mymap.setView(e.latlng, 17);
      });
      mymap.on("locationerror", function (e) {
        console.log(e);
        alert("Location wasn't found");
      });
      mymap.on("zoomend", function (e) {
        $("#zoom-level").html(mymap.getZoom());
      });
      mymap.on("moveend",function(e){
        $("#map-center").html(LatLngToArrayString(mymap.getCenter()));
      })
      mymap.on("mousemove",function(e){
        $("#mouse-location").html(LatLngToArrayString(e.latlng));
      })
      function LatLngToArrayString(ll){
        console.log(ll);
        return "["+ll.lat.toFixed(5)+" , "+ll.lng.toFixed(5)+"]";
      }
      $("#btnLocate").click(function(){
        mymap.locate();
      })
      $("#btnZocalo").click(function(){
        mymap.setView([19.43262,-99.13325],17)
        mymap.openPopup(popZocalo); 
      })
      
    </script>
  </body>
</html>
